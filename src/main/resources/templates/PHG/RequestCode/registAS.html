<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì‹œì„¤ A/S ì ‘ìˆ˜</title>
  <th:block th:replace="/PHG/RequestCode/headScript :: headScript"></th:block>
  <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
  <link rel="stylesheet" type="text/css" href="/css/PHG_css/Request_css/registAS.css">
</head>
<body>
  <th:block th:replace="/PHG/RequestCode/header :: header"></th:block>

  <main>
    <div class="maintenance-report">
      <h1>ì‹œì„¤ A/S ì ‘ìˆ˜</h1>
      <hr>
      
      <div class="report-form">
        <form id="maintenanceForm" action="/schedule/registAS/insert" method="post">
          <input type="hidden" name="userId" th:value="${session.userId}">

          <!-- ì‹ ê³ ì ì •ë³´ ì„¹ì…˜ (ê¸°ì¡´ ì½”ë“œ ë™ì¼) -->
          <table class="info-table">
            <caption>
              <span class="caption-icon">ğŸ‘¤</span>
              ì‹ ê³ ì ì •ë³´
              <span class="required-note">* í•„ìˆ˜ ì…ë ¥ í•­ëª©</span>
            </caption>
            <tbody>
              <tr>
                <th><label for="name">ì´ë¦„ *</label></th>
                <td>
                  <div class="input-wrapper">
                    <input type="text" name="name" id="name" placeholder="ì‹ ê³ ì ì„±ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                  </div>
                </td>
              </tr>
              <tr>
                <th><label for="phoneNumber">ì—°ë½ì²˜ *</label></th>
                <td>
                  <div class="phone-group">
                    <input type="text" id="phoneNumber1" value="010" readonly style="width:100px; text-align:center;">
                    <span class="phone-separator">-</span>
                    <input type="tel" id="phoneNumber2" class="phone" minlength="3" maxlength="4" placeholder="xxxx" required>
                    <span class="phone-separator">-</span>
                    <input type="tel" id="phoneNumber3" class="phone" minlength="4" maxlength="4" placeholder="xxxx" required>
                    <input type="hidden" name="phoneNumber" id="phoneNumber">
                  </div>
                </td>
              </tr>
              <tr>
                <th><label for="email">ì´ë©”ì¼</label></th>
                <td>
                  <div class="input-wrapper">
                    <input type="email" name="email" id="email" placeholder="example@domain.com">
                  </div>
                </td>
              </tr>
            </tbody>
          </table>

          <!-- ì‹œì„¤ë¬¼ ì •ë³´ ì„¹ì…˜ (ê¸°ì¡´ ì½”ë“œ ë™ì¼) -->
          <table class="info-table">
            <caption>
              <span class="caption-icon">ğŸ¢</span>
              ì‹œì„¤ë¬¼ ì •ë³´
            </caption>
            <tbody>
              <tr>
                <th><label for="address">ì‹œì„¤ë¬¼ ìœ„ì¹˜ *</label></th>
                <td>
                  <div class="address-group">
                    <button type="button" onclick="searchAddress()" class="address-search-btn">ì£¼ì†Œ ê²€ìƒ‰</button>
                    <input type="text" id="postcode" name="postcode" placeholder="ìš°í¸ë²ˆí˜¸" readonly required>
                    <input type="text" id="address" name="address" placeholder="ì£¼ì†Œ" readonly required>
                    <input type="text" id="detailAddress" name="detailAddress" placeholder="ìƒì„¸ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                  </div>
                </td>
              </tr>
              <tr>
                <th><label for="facilityType">ì‹œì„¤ë¬¼ ë¶„ë¥˜ *</label></th>
                <td>
                  <div class="input-wrapper">
                    <select name="facilityType" id="facilityType" required>
                      <option value="">ì‹œì„¤ë¬¼ ì„ íƒ</option>
                      <optgroup label="ì „ê¸° ì‹œì„¤">
                        <option value="lighting">ì¡°ëª…</option>
                        <option value="power">ì „ì›</option>
                        <option value="communication">í†µì‹ </option>
                      </optgroup>
                      <optgroup label="ì„¤ë¹„ ì‹œì„¤">
                        <option value="plumbing">ë°°ê´€</option>
                        <option value="hvac">ê³µì¡°</option>
                        <option value="elevator">ìŠ¹ê°•ê¸°</option>
                      </optgroup>
                      <optgroup label="ì•ˆì „ ì‹œì„¤">
                        <option value="fire">ì†Œë°©</option>
                        <option value="security">ë³´ì•ˆ</option>
                        <option value="emergency">ë¹„ìƒ</option>
                      </optgroup>
                      <optgroup label="ê¸°íƒ€ ì‹œì„¤">
                        <option value="interior">ë‚´ë¶€ì‹œì„¤</option>
                        <option value="exterior">ì™¸ë¶€ì‹œì„¤</option>
                        <option value="other">ê¸°íƒ€</option>
                      </optgroup>
                    </select>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>

          <!-- ìƒì„¸ ì •ë³´ ì„¹ì…˜ -->
          <table class="info-table">
            <caption>
              <span class="caption-icon">ğŸ“</span>
              ìƒì„¸ ì •ë³´
            </caption>
            <tbody>
              <tr>
                <th><label for="issueTitle">ì œëª© *</label></th>
                <td>
                  <div class="input-wrapper">
                    <input type="text" name="issueTitle" id="issueTitle" placeholder="ë¬¸ì œë¥¼ ê°„ë‹¨íˆ ì„¤ëª…í•´ì£¼ì„¸ìš”" required>
                  </div>
                </td>
              </tr>
              <tr>
                <th><label for="issueDetails">ìƒì„¸ì„¤ëª… *</label></th>
                <td>
                  <div class="input-wrapper">
                    <textarea name="issueDetails" id="issueDetails" placeholder="ë°œìƒí•œ ë¬¸ì œì— ëŒ€í•´ ìì„¸íˆ ì„¤ëª…í•´ì£¼ì„¸ìš”" required></textarea>
                    <div class="textarea-footer">
                      <span class="char-count">0/2000</span>
                    </div>
                  </div>
                </td>
              </tr>
              <tr>
                <th><label for="preferredDate">ë°©ë¬¸ ê°€ëŠ¥ ì¼ì *</label></th>
                <td>
                  <div class="visit-time-wrapper">
                    <div class="date-select">
                      <input type="date" id="preferredDate" required>
                    </div>
                  </div>
                </td>
              </tr>
              <tr>
                <th><label for="preferredTime">ë°©ë¬¸ ê°€ëŠ¥ ì‹œê°„ *</label></th>
                <td>
                  <div class="input-wrapper">
                    <select id="preferredTime" required>

                    </select>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>

          <input type="hidden" name="preferredDateTime" id="preferredDateTime">

          <!-- ê°œì¸ì •ë³´ ë™ì˜ ì„¹ì…˜ -->
          <div class="privacy-agreement">
            <h3>ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš© ë™ì˜</h3>
            <div class="agreement-content">
              <p>1. ìˆ˜ì§‘í•˜ëŠ” ê°œì¸ì •ë³´ í•­ëª©: ì„±ëª…, ì—°ë½ì²˜, ì´ë©”ì¼</p>
              <p>2. ìˆ˜ì§‘ ëª©ì : A/S ì‹ ì²­ ì²˜ë¦¬ ë° ê²°ê³¼ íšŒì‹ </p>
              <p>3. ë³´ìœ  ê¸°ê°„: ì‹ ì²­ì¼ë¡œë¶€í„° 1ë…„</p>
            </div>
            <div class="agreement-checkbox">
              <input type="checkbox" name="privacyAgreement" id="privacyAgreement" required onchange="validateDateTime()">
              <label for="privacyAgreement" onchange="validateDateTime()">ìœ„ ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš©ì— ë™ì˜í•©ë‹ˆë‹¤. *</label>
            </div>
          </div>
          
          <!-- ë²„íŠ¼ ê·¸ë£¹ -->
          <div class="button-group">
            <button type="submit" class="submit-btn">ì‹ ê³ ì„œ ì œì¶œ</button>
            <button type="reset" class="reset-btn">ì´ˆê¸°í™”</button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <th:block th:replace="/PHG/RequestCode/footer :: footer"></th:block>

  <script>
    // ì£¼ì†Œ ê²€ìƒ‰ í•¨ìˆ˜ - ì „ì—­ ìŠ¤ì½”í”„ì— ì •ì˜
    function searchAddress() {
        new daum.Postcode({
            oncomplete: function(data) {
                document.getElementById('postcode').value = data.zonecode;
                document.getElementById('address').value = data.address;
                document.getElementById('detailAddress').focus();
            }
        }).open();
    }

    document.addEventListener('DOMContentLoaded', function() {
        // DOM ìš”ì†Œ ì°¸ì¡°
        const form = document.getElementById('maintenanceForm');
        const phoneNumber2 = document.getElementById('phoneNumber2');
        const phoneNumber3 = document.getElementById('phoneNumber3');
        const textarea = document.getElementById('issueDetails');
        const charCount = document.querySelector('.char-count');
        const preferredDate = document.getElementById('preferredDate');
        const preferredTime = document.getElementById('preferredTime');
        const privacyCheckbox = document.getElementById('privacyAgreement');
        
        // 1) ë‚´ì¼ ë‚ ì§œ(ì˜¤ëŠ˜ +1ì¼)ë¥¼ minìœ¼ë¡œ ì„¤ì • -> ì˜¤ëŠ˜ê¹Œì§€ëŠ” ì„ íƒ ë¶ˆê°€
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1); 
        const tomorrowString = tomorrow.toISOString().split('T')[0];
        preferredDate.setAttribute('min', tomorrowString);

        // ë‚ ì§œ ì„ íƒ ì‹œ ê°€ëŠ¥í•œ ì‹œê°„ ìŠ¬ë¡¯ ë¡œë“œ
        preferredDate.addEventListener('change', function() {
            const selectedDate = this.value;
            const preferredTimeSelect = document.getElementById('preferredTime');
            
            // ëª¨ë“  ì˜µì…˜ ì´ˆê¸°í™”
            preferredTimeSelect.innerHTML = '<option value="">ì‹œê°„ ì„ íƒ</option>';
            
            // AJAX ìš”ì²­
            fetch(`/schedule/registAS/checkAvailableTimeSlots?selectedDate=${selectedDate}`)
                .then(response => response.json())
                .then(availableTimeSlots => {
                    availableTimeSlots.forEach(timeSlot => {
                        const option = document.createElement('option');
                        option.value = timeSlot;
                        option.textContent = `${timeSlot.split(':')[0]}ì‹œ`;
                        preferredTimeSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('ì‹œê°„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                });
        });

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜: ì‹œê°„ì„ ì œì™¸í•œ ë‚ ì§œ ê°ì²´
        function getDateWithoutTime(date) {
            return new Date(date.getFullYear(), date.getMonth(), date.getDate());
        }

        // ë°©ë¬¸ ì¼ì/ì‹œê°„ ìœ íš¨ì„± ê²€ì‚¬ (ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ ì²´í¬ë°•ìŠ¤ ìë™ í•´ì œ)
        function validateDateTime() {
            if (!preferredDate.value || !preferredTime.value) {
                // ë‘˜ ì¤‘ í•˜ë‚˜ë¼ë„ ì„ íƒë˜ì§€ ì•Šì€ ê²½ìš° ë³„ë„ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ
                return true;
            }
            
            const selectedDate = new Date(preferredDate.value);
            const selectedTime = preferredTime.value;
            const now = new Date();
            
            const todayWithoutTime = getDateWithoutTime(now);
            const selectedDateWithoutTime = getDateWithoutTime(selectedDate);
            
            // ê³¼ê±° ë‚ ì§œì¸ ê²½ìš°
            if (selectedDateWithoutTime < todayWithoutTime) {
                alert("ê³¼ê±° ë‚ ì§œëŠ” ì„ íƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                preferredDate.value = '';
                privacyCheckbox.checked = false;  // ì²´í¬ë°•ìŠ¤ ìë™ í•´ì œ
                return false;
            }

            // ì˜¤ëŠ˜ ë‚ ì§œì¸ ê²½ìš° ì‹œê°„ë„ ë¹„êµ(ë§Œì•½ ì˜¤ëŠ˜ ë‚ ì§œë¥¼ ë§‰ì•„ë‘ì§€ ì•ŠëŠ”ë‹¤ë©´)
            if (selectedDateWithoutTime.getTime() === todayWithoutTime.getTime()) {
                const currentHour = now.getHours();
                const selectedHour = parseInt(selectedTime.split(':')[0]);
                
                if (selectedHour <= currentHour) {
                    alert("í˜„ì¬ ì‹œê°„ ì´í›„ì˜ ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                    preferredTime.value = '';
                    privacyCheckbox.checked = false;
                    return false;
                }
            }
            return true;
        }

        // ìƒì„¸ì„¤ëª… ê¸€ììˆ˜ ì¹´ìš´íŒ…
        function updateCharCount() {
            const currentLength = textarea.value.length;
            charCount.textContent = `${currentLength}/2000`;
            
            if (currentLength > 2000) {
                textarea.value = textarea.value.substring(0, 2000);
                charCount.textContent = '2000/2000';
            }
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        textarea.addEventListener('input', updateCharCount);
        preferredDate.addEventListener('change', validateDateTime);
        preferredTime.addEventListener('change', validateDateTime);

        // í¼ ì œì¶œ ì´ë²¤íŠ¸
        form.addEventListener('submit', function(event) {
            event.preventDefault();

            // ë‚ ì§œ/ì‹œê°„ ìœ íš¨ì„± ê²€ì‚¬
            if (!validateDateTime()) {
                return;
            }

            // ì „í™”ë²ˆí˜¸ ì¡°í•©
            try {
                const phoneNumber1 = document.getElementById('phoneNumber1').value;
                document.getElementById('phoneNumber').value = 
                  `${phoneNumber1}-${phoneNumber2.value}-${phoneNumber3.value}`;

                // ë°©ë¬¸ ì¼ìì™€ ì‹œê°„ í•©ì¹˜ê¸°
                const selectedDate = preferredDate.value;
                const selectedTime = preferredTime.value;
                
                
                if (selectedDate && selectedTime) {
                  // datetime í˜•ì‹ìœ¼ë¡œ ì •í™•íˆ í•©ì¹˜ê¸° (YYYY-MM-DD HH:mm:ss)
                  const combinedDateTime = `${selectedDate} ${selectedTime}`;
                  document.getElementById('preferredDateTime').value = combinedDateTime;
                  
                } else {
                    // ë‚ ì§œë‚˜ ì‹œê°„ì´ ì„ íƒë˜ì§€ ì•Šì•˜ì„ ê²½ìš° ì²˜ë¦¬
                    alert('ë°©ë¬¸ ê°€ëŠ¥ ì¼ìì™€ ì‹œê°„ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    event.preventDefault(); // í¼ ì œì¶œ ë°©ì§€
                }
                
                // ëª¨ë“  ê²€ì¦ í†µê³¼ ì‹œ í¼ ì œì¶œ
                this.submit();
            } catch (error) {
                console.error('ì „í™”ë²ˆí˜¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
                alert('ì „í™”ë²ˆí˜¸ ì •ë³´ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
            }
        });

        // ì´ˆê¸°í™” ë²„íŠ¼ ì´ë²¤íŠ¸
        const resetBtn = document.querySelector('.reset-btn');
        if (resetBtn) {
            resetBtn.addEventListener('click', function() {
                setTimeout(() => {
                    form.reset();
                    charCount.textContent = '0/2000';
                    privacyCheckbox.checked = false;
                }, 0);
            });
        }
    });
  </script>
</body>
</html>