<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì „ê¸°ì  ì„¸ë¶€ìš”ì¸ë³„ AI ìœ„í—˜ì ìˆ˜ ì˜ˆì¸¡</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h2>ì§€ì—­ë³„ ì „ê¸°ì  ì„¸ë¶€ìš”ì¸ë³„ ìœ„í—˜ì ìˆ˜ AIì˜ˆì¸¡ì— ë”°ë¥¸ ìš”ì¸ë³„ ê°ì†Œê¸°ì—¬ë„</h2>
    <label for="regionSelect">ì§€ì—­ ì„ íƒ:</label>
    <select id="regionSelect">
        <option value="">ì „ì²´</option>
    </select>
    <canvas id="riskChart"></canvas>

    <script>
        $(document).ready(function () {
            let chart;
            const ctx = document.getElementById('riskChart').getContext('2d');
            let fullData = [];
            let excludedCauses = [];

            // âœ… **ì§€ì—­ë³„ ì´ ìœ„í—˜ì ìˆ˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì •ê·œí™”**
            function normalizeDataByRegion(data, region) {
                let regionData = region ? data.filter(d => d.Region === region) : data;
                let regionTotalRisk = regionData.reduce((sum, d) => sum + parseFloat(d["Reduction (%)"]), 0);

                console.log(`ğŸ“Œ [${region || "ì „ì²´"}] ì§€ì—­ë³„ ì´ ìœ„í—˜ì ìˆ˜:`, regionTotalRisk);

                return regionData.map(d => ({
                    ...d,
                    "Reduction (%)": ((parseFloat(d["Reduction (%)"]) / regionTotalRisk) * 100).toFixed(2)
                }));
            }

            // âœ… **ì„œë²„ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°**
            $.getJSON("/aiRisk/data", function (riskData) {
                fullData = riskData;
                populateSelect(fullData);
                updateChart(fullData, "", []);
            });

            function populateSelect(data) {
                let uniqueRegions = [...new Set(data.map(d => d.Region))];
                uniqueRegions.forEach(region => {
                    $("#regionSelect").append(`<option value="${region}">${region}</option>`);
                });
            }

            // âœ… **ì›ì¸ì„ ê·¸ë£¹í™”í•˜ì—¬ ì¤‘ë³µ ì œê±°**
            function aggregateByCause(data, excludeCauses = []) {
                let grouped = {};
                data.forEach(d => {
                    if (excludeCauses.includes(d.Cause)) return;
                    if (!grouped[d.Cause]) {
                        grouped[d.Cause] = { Cause: d.Cause, Reduction: 0 };
                    }
                    grouped[d.Cause].Reduction += parseFloat(d["Reduction (%)"]);
                });

                return Object.values(grouped);
            }

            // âœ… **ì œê±°ëœ ì›ì¸ì˜ ê¸°ì—¬ë„ë¥¼ ë‚¨ì€ ìš”ì¸ì— ë¹„ë¡€í•˜ì—¬ ì¬ë¶„ë°°**
            function redistributeReduction(data, excludeCauses) {
                let filteredData = data.filter(d => !excludeCauses.includes(d.Cause));
                let remainingTotal = filteredData.reduce((sum, d) => sum + parseFloat(d.Reduction), 0);

                console.log("ğŸ“Œ ì œê±°ëœ ì›ì¸ ì´í›„ ì´í•© (ì¬ì¡°ì • ì „):", remainingTotal);

                return filteredData.map(d => ({
                    Cause: d.Cause,
                    Reduction: ((parseFloat(d.Reduction) / remainingTotal) * 100).toFixed(2)
                }));
            }

            // âœ… **ì°¨íŠ¸ ì—…ë°ì´íŠ¸ (ì§€ì—­ë³„ ê¸°ì¤€)**
            function updateChart(riskData, region, excludeCauses) {
                console.log("ğŸ“Œ ì°¨íŠ¸ ì—…ë°ì´íŠ¸ ì‹œì‘", { region, excludeCauses });

                let normalizedData = normalizeDataByRegion(riskData, region);
                let aggregatedData = aggregateByCause(normalizedData, excludeCauses);

                if (excludeCauses.length > 0) {
                    aggregatedData = redistributeReduction(aggregatedData, excludeCauses);
                }

                aggregatedData.sort((a, b) => b.Reduction - a.Reduction);
                const labels = aggregatedData.map(d => d.Cause);
                const values = aggregatedData.map(d => d.Reduction);

                if (chart) {
                    chart.options.plugins.legend.onClick = null;
                    chart.destroy();
                }

                console.log("ğŸ“Œ ì°¨íŠ¸ ë°ì´í„°", { labels, values });

                chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'ìœ„í—˜ ê°ì†Œ ê¸°ì—¬ë„',
                            data: values,
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        onClick: (event, elements) => {
                            if (elements.length > 0 && elements[0] !== undefined) {
                                let index = elements[0].index;
                                let cause = chart.data.labels[index];

                                if (!excludedCauses.includes(cause)) {
                                    excludedCauses.push(cause);
                                    updateChart(fullData, $("#regionSelect").val(), excludedCauses);
                                }
                            }
                        },
                        scales: { 
                            y: { beginAtZero: true, max: 100 } 
                        }
                    }
                });
            }

            $("#regionSelect").change(function () {
                let selectedRegion = $(this).val();
                excludedCauses = [];
                updateChart(fullData, selectedRegion, excludedCauses);
            });
        });
    </script>
</body>
</html>
<!--  -->